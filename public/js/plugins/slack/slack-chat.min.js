!function(e){var s,a={};window.slackChat=!1;var t={init:function(s){this._defaults={apiToken:"",channelId:"",user:"",userLink:"",userImg:"",userId:"",defaultSysImg:"",defaultSysUser:"",queryInterval:3e3,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:"",sendOnEnter:!0,disableIfAway:!1,elementToDisable:null,heightOffset:75,debug:!1,defaultUserImg:"",webCache:!1,privateChannel:!1,privateChannelId:!1,isOpen:!1,badgeElement:!1,serverApiGateway:"/server/php/server.php",useUserDetails:!1,defaultInvitedUsers:[]},this._options=e.extend(!0,{},this._defaults,s),this._options.queryIntElem=null,this._options.latest=null,this._options.debug&&console.log("This object :",this),window.slackChat._options=a=this._options,""==this._options.apiToken&&t.validationError("Parameter apiToken is required."),""!=this._options.channelId||this._options.privateChannel||t.validationError("Parameter channelId is required."),""==this._options.user&&t.validationError("Parameter user is required."),""==this._options.defaultSysUser&&t.validationError("Parameter defaultSysUser is required."),""==this._options.botUser&&t.validationError("Parameter botUser is required."),"undefined"==typeof moment&&t.validationError("MomentJS is not available. Get it from http://momentjs.com"),this._options.disableIfAway&&null!==this._options.elementToDisable&&this._options.elementToDisable.hide();var o='<div class="slackchat slack-chat-box">';o+='<div class="slack-chat-header">',o+='<button class="close slack-chat-close">&times;</button>',o+=this._options.chatBoxHeader,o+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>",o+="</div>",o+='<div class="slack-message-box">',o+="</div>",o+='<div class="send-area">',o+='<textarea class="form-control slack-new-message" disabled="disabled" type="text" placeholder="Hang tight while we connect..."></textarea>',o+='<div class="slack-post-message"><i class="fa fa-fw fa-chevron-right"></i></div>',o+="</div>",o+="</div>",e("body").append(o);var n=window.slackChat=this;e(this).on("click",function(){if(window.slackChat._options.badgeElement&&e(window.slackChat._options.badgeElement).html("").hide(),window.slackChat._options.privateChannel&&(window.slackChat._options.isOpen=!0),e(".slack-chat-box").show(),e(".slack-chat-box").addClass("open"),e(".slack-message-box").height(e(".slack-chat-box").height()-e(".desc").height()-e(".send-area").height()-parseInt(window.slackChat._options.heightOffset)),!function a(){(e(".slack-chat-box").hasClass("open")||window.slackChat._options.privateChannel)&&(t.querySlack(n),setTimeout(a,window.slackChat._options.queryInterval))}(),e(".slackchat .slack-new-message").focus(),window.slackChat._options.webCache){var s={apiToken:window.slackChat._options.apiToken,channelId:window.slackChat._options.channelId,user:window.slackChat._options.user,defaultSysUser:window.slackChat._options.defaultSysUser,botUser:window.slackChat._options.botUser,serverApiGateway:window.slackChat._options.serverApiGateway,defaultInvitedUsers:window.slackChat._options.defaultInvitedUsers};localStorage.scParams=JSON.stringify(s)}}),e(".slackchat .slack-chat-close").on("click",function(){e(".slack-chat-box").slideUp(),e(".slack-chat-box").removeClass("open"),window.slackChat._options.privateChannel?window.slackChat._options.isOpen=!1:clearInterval(window.slackChat._options.queryIntElem)}),e(".slackchat .slack-post-message").click(function(){t.postMessage(window.slackChat,window.slackChat._options)}),e(".slackchat .slack-new-message").keyup(function(e){if(window.slackChat._options.sendOnEnter){var s=e.keyCode?e.keyCode:e.which;13==s&&(t.postMessage(window.slackChat,window.slackChat._options),e.preventDefault())}}),t.getUserPresence(window.slackChat,window.slackChat._options)},querySlack:function(o){options=window.slackChat._options,t.createChannel(o,function(o){window.slackChat._options.channelId=o.id,e(".slack-new-message").prop("disabled",!1).prop("placeholder","Write a message..."),e.ajax({url:"https://slack.com/api/channels.history",type:"POST",dataType:"json",data:{token:options.apiToken,channel:a.channelId,oldest:a.latest,count:options.messageFetchCount},success:function(a){if(options.debug&&a.messages&&a.messages.length&&console.log(a.messages),a.ok&&a.messages.length){var o="";window.slackChat._options.latest=a.messages[0].ts,a.messages=a.messages.reverse();for(var n=0,i=0;i<a.messages.length;i++)if("bot_message"==a.messages[i].subtype&&""!==a.messages[i].text){message=a.messages[i];var r="",l="",c="";message.attachments&&(r=message.attachments[0].author_name,l=message.attachments[0].author_icon),message.fields&&(c=message.fields[0].value);var d=t.formatMessage(message.text.trim());o+="<div class='message-item'>",""!==l&&"undefined"!=typeof l?o+="<div class='userImg'><img src='"+l+"' /></div>":""!==options.defaultUserImg&&(o+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>"),o+="<div class='msgBox'>",o+=""!==c?"<div class='username'>"+(c==options.userId?"You":r)+"</div>":"<div class='username'>"+r+"</div>",o+="<div class='message'>"+d+"</div>","undefined"!=typeof moment&&(o+="<div class='timestamp'>"+moment.unix(a.messages[i].ts).fromNow()+"</div>"),o+="</div>",o+="</div>"}else if("undefined"==typeof a.messages[i].subtype){n++,d=t.formatMessage(a.messages[i].text.trim());var h=a.messages[i].user,r=options.defaultSysUser,l=options.defaultSysImg;if(options.useUserDetails&&s.length)for(var p=0;p<s.length;p++){var u=s[p];if(u.id==h){r=void 0!=u.real_name&&u.real_name.length>0?u.real_name:u.name,l=u.profile.image_48;break}}o+="<div class='message-item'>",""!==l&&(o+="<div class='userImg'><img src='"+l+"' /></div>"),o+="<div class='msgBox'>",o+="<div class='username main'>"+r+"</div>",o+="<div class='message'>"+d+"</div>","undefined"!=typeof moment&&(o+="<div class='timestamp'>"+moment.unix(a.messages[i].ts).fromNow()+"</div>"),o+="</div>",o+="</div>"}e(".slack-message-box").append(o),e(".slack-message-box").stop().animate({scrollTop:e(".slack-message-box")[0].scrollHeight},800),n>0&&window.slackChat._options.isOpen===!1&&window.slackChat._options.badgeElement&&e(window.slackChat._options.badgeElement).html(n).show()}else a.ok||(console.log("[SlackChat] Query failed with errors: "),console.log(a))}})})},postMessage:function(s){var a=s._options,t={};return t.fallback="View "+a.user+"'s profile",t.color=a.slackColor,t.author_name=a.user,""!==a.userLink&&(t.author_link=a.userLink),""!==a.userImg&&(t.author_icon=a.userImg),""!==a.userId&&(t.fields=[{title:"ID",value:a.userId,"short":!0}]),""===e(".slack-new-message").val().trim()?!1:(message=e(".slack-new-message").val(),e(".slack-new-message").val(""),a.debug&&(console.log("Posting Message:"),console.log({message:message,attachment:t,options:a})),void e.ajax({url:"https://slack.com/api/chat.postMessage",type:"POST",dataType:"json",data:{token:a.apiToken,channel:window.slackChat._options.channelId,text:message,username:a.botUser,attachments:JSON.stringify([t])},success:function(s){s.ok||(e(".slack-new-message").val(message),console.log("[SlackChat] Post Message failed with errors: "),console.log(s))}}))},validationError:function(s){return e.error("[SlackChat Error] "+s),!1},getUserPresence:function(a){var t=a._options,o=!1;s=[],e.ajax({url:"https://slack.com/api/users.list",type:"POST",dataType:"json",data:{token:t.apiToken},success:function(a){if(a.ok&&(s=a.members,s.length))for(var n=0;n<s.length&&!o;n++)s[n].is_bot||e.ajax({url:"https://slack.com/api/users.getPresence",dataType:"json",type:"POST",data:{token:t.apiToken,user:s[n].id},success:function(s){if(s.ok){if("active"===s.presence)return e(".slackchat .presence").addClass("active"),e(".slackchat .presence .presence-text").text("Available"),t.disableIfAway&&null!==t.elementToDisable&&t.elementToDisable.show(),o=!0,!0;o||(e(".slackchat .presence").removeClass("active"),e(".slackchat .presence .presence-text").text("Away"))}}})}})},destroy:function(s){e(s).unbind("click"),e(window.slackChat).unbind("click"),e(".slackchat").remove()},formatMessage:function(s){var a=e("<textarea/>").html(s).text();return decodeURI(a).replace(/<(.+?)(\|(.*?))?>/g,function(s,a,t,o){return o||(o=a),e("<a>").attr({href:a,target:"_blank"}).text(o).prop("outerHTML")}).replace(/(?:[`]{3,3})(?:\n)?([a-zA-Z0-9<>\\\.\*\n\r\-_ ]+)(?:\n)?(?:[`]{3,3})/g,function(s,a){return e("<code>").text(a).prop("outerHTML")}).replace(/(?:[`]{1,1})([a-zA-Z0-9<>\\\.\*\n\r\-_ ]+)(?:[`]{1,1})/g,function(s,a){return e("<code>").text(a).prop("outerHTML")}).replace(/\n/g,"<br />")},createChannel:function(s,a){var t=s._options;if(!t.privateChannel){var o={id:t.channelId};return a(o),!1}if(t.privateChannelId){var o={id:t.privateChannelId};return a(o),!1}var n=t.user+"-"+(t.userId?t.userId:1e5*Math.random()),i={channelName:n};t.defaultInvitedUsers.length>0&&(i.invitedUsers=JSON.stringify(t.defaultInvitedUsers)),e.ajax({url:t.serverApiGateway,dataType:"json",type:"POST",data:i,success:function(e){return e.ok&&(t.privateChannelId=window.slackChat._options.privateChannelId=e.data.id,a(e.data)),!1},error:function(){return!1}})}};e.fn.slackChat=function(s){return t[s]?t[s].apply(this,Array.prototype.slice.call(arguments,1)):void("object"!=typeof s&&s?e.error("Method "+s+" does not exist on jQuery.slackChat"):t.init.apply(this,arguments))}}(jQuery);
